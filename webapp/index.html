<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>–ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± ‚Äî 8-bit Runner</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="46" fill="%2353B5AF"/><text x="50" y="70" text-anchor="middle" font-size="70" fill="black">üß™</text></svg>'>
  <style>
    :root{
      --brand:#53B5AF; --brand-2:#53B5AF;
      --bg:#000000; --card:#000000; --text:#ffffff; --muted:#cfe9e7;
      --pad:12px; --app-height:100vh;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family:monospace; background:var(--bg); color:var(--text); }

    /* –∫–æ—Ä–µ–Ω—å, –∫–æ—Ç–æ—Ä—ã–π ¬´–ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º¬ª –≤ –ø–æ—Ä—Ç—Ä–µ—Ç–µ */
    #app-root{ position:relative; width:100%; min-height:var(--app-height); display:flex; }
    .portrait-force-landscape #app-root{
      position:fixed; inset:0; transform:rotate(90deg); transform-origin:top left;
      width:calc(var(--app-height)); height:100vw; overflow:hidden; z-index:1;
    }

    .wrap{ flex:1; display:flex; }
    .card{
      flex:1; display:flex; flex-direction:column; background:var(--card);
      border:3px solid var(--brand); image-rendering:pixelated;
      box-shadow:0 0 18px rgba(83,181,175,.35);
    }
    h1{
      font-size:20px; margin:0; padding:10px var(--pad); display:flex; align-items:center; gap:10px;
      background:linear-gradient(45deg, rgba(83,181,175,.10), rgba(83,181,175,.10));
      border-bottom:1px solid rgba(83,181,175,.35); color:var(--text);
    }
    .gameBox{ flex:1; display:flex; flex-direction:column; min-height:0; }
    canvas{
      display:block; width:100%; height:auto; background:#000000; image-rendering:pixelated;
      touch-action: manipulation; -webkit-user-select:none; user-select:none;
    }
    .bar{ display:flex; justify-content:space-between; align-items:flex-start; gap:8px; padding:8px var(--pad); flex-wrap:wrap; }
    .hint{ font-size:12px; color:var(--muted); }
    .btn{ background:#000000; color:var(--text); border:2px solid var(--brand); padding:8px 12px; cursor:pointer; border-radius:8px; }
    .btn:active{ background:var(--brand); color:#000000; }
    .btn.brand{ background:var(--brand); color:#000000; border-color:transparent; }

    /* –æ–≤–µ—Ä–ª–µ–∏ */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.92); display:none;
      align-items:center; justify-content:center; padding:16px; z-index:999; height:var(--app-height); }
    .panel{ background:#000000; border:3px solid var(--brand); border-radius:10px;
      box-shadow:0 0 18px rgba(83,181,175,.35); width:100%; max-width:860px;
      max-height:calc(var(--app-height) - 32px); display:flex; flex-direction:column; }
    .panel .inner{ display:grid; gap:14px; padding:16px; grid-template-columns:1fr 320px; overflow:auto; }
    @media (max-width:740px){ .panel .inner{ grid-template-columns:1fr; } }
    input[type="text"],input[type="tel"],input[type="email"]{
      width:100%; background:#000000; border:2px solid var(--brand); color:#ffffff; padding:8px; border-radius:6px; margin-top:4px;
    }
    .field{ margin:6px 0; }
    .checkbox{ display:flex; gap:8px; align-items:flex-start; font-size:12px; color:#e9f7f6; }
    .note{ font-size:11px; color:#cfe9e7; }
    .prizes{ border:2px solid var(--brand); border-radius:8px; padding:10px; background:#000000; }
    .prizes h3{ margin:0 0 8px; font-size:16px; color:#ffffff; }
    .prize-row{ display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed rgba(83,181,175,.45); }
    .prize-row:last-child{ border-bottom:none; }

    /* –æ–≤–µ—Ä–ª–µ–π-–ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ –ø–æ–≤–æ—Ä–æ—Ç */
    .rotate-hint{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.9); color:#ffffff; z-index:10000; text-align:center; padding:16px;
      border:3px solid var(--brand);
    }
    .rotate-hint.show{ display:flex; }
  </style>
</head>
<body>
  <div id="app-root">
    <div class="wrap">
      <div class="card">
        <h1>üß™ –ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± 8-bit Runner</h1>
        <div class="gameBox">
          <canvas id="game" width="1200" height="400"></canvas>
          <div class="bar">
            <div>
              –û—á–∫–∏: <span id="score">0</span> ¬∑ –†–µ–∫–æ—Ä–¥: <span id="best">0</span> ¬∑ –û—Å—Ç–∞–ª–æ—Å—å: <span id="timeLeft">02:00</span>
              <div class="hint">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Space / ‚¨ÜÔ∏é / –¢–∞–ø ¬∑ –î–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫ ‚Äî –≤—Ç–æ—Ä–æ–π —Å–ª–∞–±–µ–µ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ~0.35 —Å.</div>
            </div>
            <div style="display:flex; gap:8px;">
              <button id="restart" class="btn">–ó–∞–Ω–æ–≤–æ</button>
              <button id="newSession" class="btn brand">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <div id="regOverlay" class="overlay" style="display:flex">
      <div class="panel">
        <div class="inner">
          <div>
            <h2 style="margin:4px 0 10px">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>

            <div class="field"><label>–§–∞–º–∏–ª–∏—è *</label>
              <input id="lastName" type="text" placeholder="–ò–≤–∞–Ω–æ–≤" required autocomplete="family-name"></div>
            <div class="field"><label>–ò–º—è *</label>
              <input id="firstName" type="text" placeholder="–ò–≤–∞–Ω" required autocomplete="given-name"></div>
            <div class="field"><label>–û—Ç—á–µ—Å—Ç–≤–æ <span class="note">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
              <input id="middleName" type="text" placeholder="–ò–≤–∞–Ω–æ–≤–∏—á" autocomplete="additional-name"></div>

            <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
              <input id="phone" type="tel" placeholder="+7 900 000-00-00" autocomplete="tel"></div>
            <div class="field"><label>Email</label>
              <input id="email" type="email" placeholder="name@example.com" autocomplete="email" inputmode="email"></div>

            <label class="checkbox"><input id="consent" type="checkbox"> –°–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</label>
            <div class="note">–î–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –≤—ã–¥–∞—á–∏ –ø—Ä–∏–∑–∞ –∏ —Å–≤—è–∑–∏ —Å –≤–∞–º–∏.</div>

            <div style="margin-top:12px; text-align:right;">
              <button id="startBtn" class="btn brand">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
            <div id="regErr" style="color:#ff8a8a; margin-top:6px;"></div>
          </div>

          <div class="prizes">
            <h3>–ü—Ä–∏–∑—ã –∏ –æ—á–∫–∏</h3>
            <div class="prize-row"><div>20‚Äì30</div><div>–ë—Ä–µ–ª–æ–∫</div></div>
            <div class="prize-row"><div>30‚Äì50</div><div>–ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫–∞</div></div>
            <div class="prize-row"><div>50‚Äì70</div><div>–®–æ–ø–ø–µ—Ä</div></div>
            <div class="prize-row"><div>70+</div><div>–¢–µ—Ä–º–æ—Å</div></div>
            <div class="note" style="margin-top:8px">–û—á–∫–∏ ‚Äî –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ 2 –º–∏–Ω—É—Ç—ã.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="resultOverlay" class="overlay">
      <div class="panel">
        <div class="inner" style="grid-template-columns:1fr;">
          <div>
            <h2 style="margin:4px 0 10px">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
            <p>–í–∞—à –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <b id="finalBest">0</b> –æ—á–∫–æ–≤.</p>
            <p>–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: <b id="prizeText">‚Äî</b></p>
            <p style="margin-top:8px">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∑–∞ –ø—Ä–∏–∑–æ–º.</p>
            <div style="margin-top:12px;text-align:right;">
              <button id="resultOk" class="btn brand">–ù–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ –ø–æ–≤–æ—Ä–æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
  <div id="rotateHint" class="rotate-hint">
    <div>
      <div style="font-size:18px; margin-bottom:8px;">–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –∞–ª—å–±–æ–º–Ω—É—é –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é</div>
      <div style="font-size:12px; color:#cfe9e7;">–î–ª—è –ª—É—á—à–µ–≥–æ –æ–ø—ã—Ç–∞ –∏–≥—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞ –ø–æ–¥ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º.</div>
    </div>
  </div>

<script>
(function(){
  /* Telegram fullscreen */
  try{
    if (window.Telegram && window.Telegram.WebApp){
      window.Telegram.WebApp.expand();
      window.Telegram.WebApp.setBackgroundColor("#000000");
      window.Telegram.WebApp.setHeaderColor("secondary_bg_color");
    }
  }catch(e){}

  /* –†–µ–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ (—Ñ–∏–∫—Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã) */
  function setAppHeight(){
    var vh = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty('--app-height', vh + 'px');
  }
  setAppHeight();
  window.addEventListener('resize', setAppHeight);
  if (window.visualViewport){ window.visualViewport.addEventListener('resize', setAppHeight, {passive:true}); }

  /* –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π landscape + –ø–æ–¥—Å–∫–∞–∑–∫–∞ */
  var root = document.documentElement;
  var rotateHint = document.getElementById('rotateHint');
  function applyOrientationMode(){
    var portrait = (window.innerHeight > window.innerWidth);
    if (portrait){
      root.classList.add('portrait-force-landscape');
      if (rotateHint) rotateHint.classList.add('show');
    } else {
      root.classList.remove('portrait-force-landscape');
      if (rotateHint) rotateHint.classList.remove('show');
    }
    if (typeof resizeCanvas === 'function') setTimeout(resizeCanvas, 50);
  }
  window.addEventListener('orientationchange', applyOrientationMode);
  window.addEventListener('resize', applyOrientationMode);
  applyOrientationMode();

  /* Canvas / —Ä–∞–∑–º–µ—Ä—ã –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
  var canvas = document.getElementById('game');
  var ctx = canvas.getContext('2d');
  var W = canvas.width, H = canvas.height;
  var GROUND_Y = H - 32;
  function resizeCanvas(){
    var rect = canvas.parentElement.getBoundingClientRect();
    var cssW = Math.max(320, Math.floor(rect.width));
    var cssH = Math.max(220, Math.floor(rect.height * 0.75));
    var dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.style.width = cssW+'px'; canvas.style.height = cssH+'px';
    canvas.width = Math.round(cssW*dpr); canvas.height = Math.round(cssH*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    W = cssW; H = cssH; GROUND_Y = H - 32;
  }
  window.addEventListener('resize', resizeCanvas);

  /* –§–æ–Ω ‚Äî –±–µ—Å—à–æ–≤–Ω—ã–π —Ç–∞–π–ª (–ø—Ä–æ–∫—Ä—É—Ç–∫–∞) */
  var bgTile = new Image(); bgTile.src = "assets/background.png";
  var bgOffset = 0;
  function drawBackground(){
    if (!bgTile.complete){ ctx.fillStyle="#000000"; ctx.fillRect(0,0,W,H); return; }
    var scale = H / bgTile.height;
    var tileW = Math.ceil(bgTile.width * scale);
    var speed = worldSpeed * 0.5;          // –ø–∞—Ä–∞–ª–ª–∞–∫—Å
    bgOffset = (bgOffset - speed);
    if (bgOffset <= -tileW) bgOffset += tileW;
    for (var x=-tileW; x < W + tileW; x += tileW){
      ctx.drawImage(bgTile, x + bgOffset, 0, tileW, H);
    }
  }

  /* –î–µ–∫–æ—Ä —Å—Ç–µ–Ω—ã (3 –æ–±—ä–µ–∫—Ç–∞), —Å–∫–æ—Ä–æ—Å—Ç—å –∫–∞–∫ —É —Ñ–æ–Ω–∞ */
  function loadImg(src){ var im=new Image(); im.src=src; return im; }
  var DECOS = [
    { img: loadImg("assets/deco_clock.png"),   w:64, h:64, weight:2 },
    { img: loadImg("assets/deco_panel.png"),   w:80, h:80, weight:3 },
    { img: loadImg("assets/deco_console.png"), w:72, h:72, weight:1 }
  ];
  var bgDecos = []; var MAX_DECOS_ON_SCREEN = 6;
  var decoTimer = 0, decoIntervalMin=1800, decoIntervalVar=2200;
  function pickDecoByWeight(){
    var total = DECOS.reduce(function(s,d){return s+d.weight;},0);
    var r = Math.random()*total;
    for (var i=0;i<DECOS.length;i++){ r -= DECOS[i].weight; if (r<=0) return DECOS[i]; }
    return DECOS[0];
  }
  function randomWallY(){ var top=Math.round(H*0.20), bottom=Math.round(H*0.45); return Math.floor(top + Math.random()*(bottom-top)); }
  function scheduleNextDeco(){ decoTimer = (window.performance && performance.now ? performance.now() : Date.now()) + decoIntervalMin + Math.random()*decoIntervalVar; }
  function updateDecoSpawner(now){
    if (bgDecos.length >= MAX_DECOS_ON_SCREEN) return;
    if (now >= decoTimer){
      var t = pickDecoByWeight(); var scale = 0.85 + Math.random()*0.4;
      bgDecos.push({ x: W+40, y: randomWallY(), w:Math.round(t.w*scale), h:Math.round(t.h*scale), img:t.img });
      scheduleNextDeco();
    }
  }
  function drawDecos(){
    var bgSpeed = worldSpeed * 0.5; // —Ä–æ–≤–Ω–æ –∫–∞–∫ —Ñ–æ–Ω
    for (var i=bgDecos.length-1; i>=0; i--){
      var d = bgDecos[i]; d.x -= bgSpeed;
      if (d.img && d.img.complete){ ctx.imageSmoothingEnabled=false; ctx.drawImage(d.img, d.x, d.y, d.w, d.h); }
      if (d.x < -d.w-20) bgDecos.splice(i,1);
    }
  }

  /* –ò–≥—Ä–æ–∫ (—Å–ø—Ä–∞–π—Ç—ã) */
  var playerSprites = {
    run: [ Object.assign(new Image(),{src:"assets/player_run1.png"}),
           Object.assign(new Image(),{src:"assets/player_run2.png"}) ],
    jump: Object.assign(new Image(),{src:"assets/player_jump.png"})
  };
  var playerAnimTime=0, playerAnimFrame=0;

  /* –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã */
  var GRAVITY=0.85;               // –±—ã—Å—Ç—Ä–æ–µ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏–µ
  var JUMP_VEL1=-15.9;            // ‚Üë –±—ã–ª–æ -12.2 (x1.3 –ø–æ –≤—ã—Å–æ—Ç–µ)
  var JUMP_VEL2=-12.4;            // ‚Üë –±—ã–ª–æ -9.5  (x1.3 –ø–æ –≤—ã—Å–æ—Ç–µ)
  var JUMP2_WINDOW_MS=350;        // –æ–∫–Ω–æ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä—ã–∂–∫–∞ (–º—Å)
  var JUMP2_MIN_UP_VY=-1.5;       // –ø–æ–∫–∞ –µ—â—ë –¥–≤–∏–∂–µ–º—Å—è –≤–≤–µ—Ä—Ö (–Ω–µ –Ω–∞ –ø–∏–∫–µ)

  var SPEED_START=7.0;
  var SPEED_ACCEL=0.04;
  var SPAWN_MIN=340, SPAWN_VAR=300;

  var worldSpeed=SPEED_START, score=0, best=0, gameOver=false, ready=false, runStart=Date.now();
  var rafId=null;

  var player = { x:50, y:GROUND_Y-56, w:56, h:56, vy:0, onGround:true, jumpCount:0, maxJumps:2, firstJumpAt:0 };

  function drawPlayer(){
    var inAir = !player.onGround;
    if (inAir){
      var imgJ = playerSprites.jump;
      if (imgJ && imgJ.complete) ctx.drawImage(imgJ, player.x, player.y, player.w, player.h);
      else { ctx.fillStyle="#ffffff"; ctx.fillRect(player.x, player.y, player.w, player.h); }
    } else {
      playerAnimTime += worldSpeed;
      if (playerAnimTime > 18){ playerAnimTime=0; playerAnimFrame=(playerAnimFrame+1)%2; }
      var imgR = playerSprites.run[playerAnimFrame];
      if (imgR && imgR.complete) ctx.drawImage(imgR, player.x, player.y, player.w, player.h);
      else { ctx.fillStyle="#ffffff"; ctx.fillRect(player.x, player.y, player.w, player.h); }
    }
  }

  /* –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è + —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å–ø–∞–≤–Ω–∞ */
  function loadImg(src){ var im=new Image(); im.src=src; return im; }
  var SPRITES = {
    HIGH:   loadImg("assets/obstacle_high.png"),
    WIDE:   loadImg("assets/obstacle_wide.png"),
    MEDIUM: loadImg("assets/obstacle_medium.png"),
    FLY:    loadImg("assets/obstacle_fly.png")
  };
  var obstacles=[]; var spawnTimer=0;
  var lastType=-1, sameTypeCount=0;

  function chooseType(){
    var bag=[0,0,1,1,2,3,0,1]; // 0 M, 1 W, 2 H, 3 F
    var t = bag[Math.floor(Math.random()*bag.length)];
    if (t===lastType && sameTypeCount>=2){
      var alt=[0,1,2,3].filter(function(x){return x!==lastType;});
      t = alt[Math.floor(Math.random()*alt.length)];
    }
    if (t===lastType) sameTypeCount++; else { sameTypeCount=1; lastType=t; }
    return t;
  }

  function spawnObstacle(){
    var type = chooseType();
    var w,h,y,sprite;
    if (type===0){ w=56; h=56;  sprite=SPRITES.MEDIUM; y=GROUND_Y-h; }
    else if (type===1){ w=96; h=56; sprite=SPRITES.WIDE;   y=GROUND_Y-h; }
    else if (type===2){ w=56; h=112; sprite=SPRITES.HIGH;  y=GROUND_Y-h; }
    else { w=64; h=40;  sprite=SPRITES.FLY;    y=GROUND_Y-90-h; if (y<16) y=16; }
    obstacles.push({ x:W+10, y:y, w:w, h:h, sprite:sprite, passed:false });
  }

  /* --- –•–∏—Ç–±–æ–∫—Å—ã –º–µ–Ω—å—à–µ —Å–ø—Ä–∞–π—Ç–æ–≤ --- */
  var OB_HIT_W = 0.85,  OB_HIT_H = 0.80;  // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ: —É–∂–µ –∏ –Ω–∏–∂–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
  var PL_HIT_W = 0.80,  PL_HIT_H = 0.90;  // –∏–≥—Ä–æ–∫: —á—É—Ç—å —É–∂–µ –∏ –Ω–∏–∂–µ

  function playerHitbox(p){
    var w = p.w * PL_HIT_W, h = p.h * PL_HIT_H;
    var x = p.x + (p.w - w)/2;
    var y = p.y + (p.h - h);
    return {x:x, y:y, w:w, h:h};
  }
  function obstacleHitbox(o){
    var w = o.w * OB_HIT_W, h = o.h * OB_HIT_H;
    var x = o.x + (o.w - w)/2;
    var isAir = o.y < (GROUND_Y - o.h);
    var y = isAir ? (o.y + (o.h - h)/2) : (o.y + (o.h - h));
    return {x:x, y:y, w:w, h:h};
  }
  function rectsOverlap(a,b){
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  /* –ü—Ä—ã–∂–∫–∏: –≤—Ç–æ—Ä–æ–π —Å–ª–∞–±–µ–µ –∏ –≤ –æ–∫–Ω–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ–∫–∞ –µ—â—ë –¥–≤–∏–∂–µ–º—Å—è –≤–≤–µ—Ä—Ö */
  function jump(){
    if (gameOver || !sessionActive() || !ready) return;

    if (player.onGround){
      player.vy = JUMP_VEL1;
      player.onGround = false;
      player.jumpCount = 1;
      player.firstJumpAt = Date.now();
      return;
    }

    var since = Date.now() - player.firstJumpAt;
    if (player.jumpCount===1 && since <= JUMP2_WINDOW_MS && player.vy < JUMP2_MIN_UP_VY){
      player.vy = JUMP_VEL2; // —Å–ª–∞–±–µ–µ, –¥–∞—ë—Ç –≤—ã—Å–æ—Ç—É, –∞ –Ω–µ ¬´–¥–∞–ª—å–Ω–æ—Å—Ç—å¬ª
      player.jumpCount = 2;
    }
  }
  window.addEventListener('keydown', function(e){
    if (e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); jump(); }
    if (e.code==='Enter' && (gameOver || !sessionActive())) startCountdown(function(){ resetRun(); });
  });
  canvas.addEventListener('pointerdown', jump);

  function loop(){ if (rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(update); }

  function update(){
    /* —Ñ–æ–Ω –∏ –¥–µ–∫–æ—Ä */
    drawBackground();
    updateDecoSpawner((window.performance && performance.now ? performance.now() : Date.now()));
    drawDecos();

    /* –∑–µ–º–ª—è */
    var grd = ctx.createLinearGradient(0,GROUND_Y,W,GROUND_Y);
    grd.addColorStop(0,"#53B5AF"); grd.addColorStop(1,"#53B5AF");
    ctx.fillStyle = grd; ctx.fillRect(0,GROUND_Y,W,2);

    if (!sessionActive()){ dimOverlay('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'); return; }

    /* –ø–ª–∞–≤–Ω—ã–π —Ä–æ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ */
    var elapsedSec = (Date.now() - runStart)/1000;
    worldSpeed = SPEED_START + SPEED_ACCEL*elapsedSec;

    /* —Å–ø–∞–≤–Ω –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π (—Å –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å—é) */
    spawnTimer -= worldSpeed;
    if (spawnTimer <= 0){
      spawnObstacle();
      var bonusGap = (Math.random()<0.18) ? 160 : 0;
      spawnTimer = SPAWN_MIN + Math.random()*SPAWN_VAR + bonusGap;
    }

    /* —Ñ–∏–∑–∏–∫–∞ –∏–≥—Ä–æ–∫–∞ */
    player.vy += GRAVITY; player.y += player.vy;
    if (player.y >= GROUND_Y - player.h){
      player.y = GROUND_Y - player.h; player.vy = 0;
      if (!player.onGround){ player.onGround = true; player.jumpCount = 0; }
    } else { player.onGround = false; }

    /* –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è */
    for (var i=obstacles.length-1;i>=0;i--){
      var o = obstacles[i]; o.x -= worldSpeed;

      if (o.sprite && o.sprite.complete){ ctx.imageSmoothingEnabled=false; ctx.drawImage(o.sprite, o.x, o.y, o.w, o.h); }
      else { ctx.fillStyle='#53B5AF'; ctx.fillRect(o.x,o.y,o.w,o.h); }

      if (o.x + o.w < 0) obstacles.splice(i,1);
      if (!o.passed && o.x + o.w < player.x){ o.passed=true; score++; updateHud(); }

      // –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å —Ö–∏—Ç–±–æ–∫—Å–∞–º–∏
      if (!gameOver && rectsOverlap(playerHitbox(player), obstacleHitbox(o))){
        gameOver = true; if (score > best){ best = score; updateHud(); }
      }
    }

    /* –∏–≥—Ä–æ–∫ */
    drawPlayer();

    if (!ready){ drawCountdown(); return; }
    if (gameOver) return;

    loop();
  }

  /* HUD / –∫–Ω–æ–ø–∫–∏ */
  var scoreEl = document.getElementById('score');
  var bestEl  = document.getElementById('best');
  var timeEl  = document.getElementById('timeLeft');
  document.getElementById('restart').onclick = function(){ if (!sessionActive()) return; startCountdown(function(){ resetRun(); }); };
  document.getElementById('newSession').onclick = openReg;
  function updateHud(){ scoreEl.textContent = String(score); bestEl.textContent = String(best); }

  /* –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è + –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É */
  var regOverlay = document.getElementById('regOverlay');
  var resultOverlay = document.getElementById('resultOverlay');
  var startBtn = document.getElementById('startBtn');
  var resultOk = document.getElementById('resultOk');
  var regErr = document.getElementById('regErr');
  var lastNameIn = document.getElementById('lastName');
  var firstNameIn = document.getElementById('firstName');
  var middleNameIn = document.getElementById('middleName');
  var phoneIn = document.getElementById('phone');
  var emailIn = document.getElementById('email');
  var consentIn = document.getElementById('consent');
  var finalBest = document.getElementById('finalBest');
  var prizeText = document.getElementById('prizeText');

  var profile = null, sessionEndAt = null, timerId = null;

  function openReg(){ regErr.textContent=''; regOverlay.style.display='flex'; }
  function closeReg(){ regOverlay.style.display='none'; }

  function normalizePhone(raw){
    if (!raw) return "";
    var d = raw.replace(/[^\d]/g,''); // —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    if (d.length===11 && d[0]==='8') d = '7'+d.slice(1);
    if (d.length===10) d = '7'+d;
    if (d.length===11 && d[0]==='7') return '+7'+d.slice(1);
    return "";
  }
  function isEmailValid(v){ if (!v) return true; return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v.trim()); }

  startBtn.onclick = function(){
    var lastName = lastNameIn.value.trim();
    var firstName = firstNameIn.value.trim();
    var middleName = middleNameIn.value.trim();
    var phoneRaw = phoneIn.value.trim();
    var email = emailIn.value.trim();

    if (!lastName){ regErr.textContent = '–£–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é'; return; }
    if (!firstName){ regErr.textContent = '–£–∫–∞–∂–∏—Ç–µ –∏–º—è'; return; }
    var phone = normalizePhone(phoneRaw);
    if (!phone){ regErr.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω. –ü—Ä–∏–º–µ—Ä: +7 900 000-00-00'; return; }
    if (!consentIn.checked) { regErr.textContent = '–ù—É–∂–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö'; return; }
    if (!isEmailValid(email)) { regErr.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e-mail'; return; }

    profile = { lastName:lastName, firstName:firstName, middleName:middleName, phone:phone, email:email };
    best = 0; score = 0; updateHud();
    sessionEndAt = Date.now() + 2*60*1000; // 2 –º–∏–Ω—É—Ç—ã
    closeReg();
    startCountdown(function(){ resetRun(); });
    tickTimer();
  };

  resultOk.onclick = function(){ resultOverlay.style.display='none'; openReg(); };

  function tickTimer(){
    clearInterval(timerId);
    timerId = setInterval(function(){
      var left = Math.max(0, (sessionEndAt || 0) - Date.now());
      timeEl.textContent = fmt(left);
      if (left <= 0){ clearInterval(timerId); showResults(); }
    }, 200);
  }
  function fmt(ms){ var s=Math.ceil(ms/1000), m=Math.floor(s/60), ss=('0'+(s%60)).slice(-2); return ('0'+m).slice(-2)+':'+ss; }
  function sessionActive(){ return sessionEndAt && Date.now() < sessionEndAt; }

  function showResults(){
    finalBest.textContent = String(best);
    prizeText.textContent = getPrize(best);
    try{
      if (window.Telegram && window.Telegram.WebApp){
        var payload = { type:'session_result', profile:profile, best:best, ts:Date.now() };
        window.Telegram.WebApp.sendData(JSON.stringify(payload));
      }
    }catch(e){}
    resultOverlay.style.display='flex';
  }
  function getPrize(p){
    if (p >= 70) return '–¢–µ—Ä–º–æ—Å';
    if (p >= 50) return '–®–æ–ø–ø–µ—Ä';
    if (p >= 30) return '–ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫–∞';
    if (p >= 20) return '–ë—Ä–µ–ª–æ–∫';
    return '‚Äî';
  }

  /* 3-2-1 –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º ‚Äî –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ */
  function startCountdown(cb){
    ready = false;
    var t = 3;
    function step(){
      drawCountdown(t);
      if (t === 0){ ready = true; if (cb) cb(); return; }
      setTimeout(function(){ t--; step(); }, 500);
    }
    step();
  }
  function drawCountdown(n){
    drawBackground();
    updateDecoSpawner((window.performance && performance.now ? performance.now() : Date.now()));
    drawDecos();
    var g=ctx.createLinearGradient(0,GROUND_Y,W,GROUND_Y);
    g.addColorStop(0,'#53B5AF'); g.addColorStop(1,'#53B5AF');
    ctx.fillStyle=g; ctx.fillRect(0,GROUND_Y,W,2);
    ctx.fillStyle = 'rgba(0,0,0,.35)'; ctx.fillRect(0,0,W,H);
    ctx.font = 'bold 56px monospace'; ctx.textAlign='center'; ctx.fillStyle = '#53B5AF';
    ctx.fillText((typeof n==='number')? n : ' ', W/2, H/2);
  }
  function dimOverlay(msg){
    ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,W,H);
    ctx.font='16px monospace'; ctx.textAlign='center'; ctx.fillStyle='#ffffff';
    ctx.fillText(msg, W/2, H/2);
  }

  /* –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ */
  function resetRun(){
    runStart = Date.now();
    worldSpeed = SPEED_START;
    score = 0; gameOver = false;
    player.y = GROUND_Y - player.h; player.vy = 0; player.onGround = true; player.jumpCount = 0;
    obstacles.length = 0; spawnTimer = 0;
    bgDecos.length = 0; bgOffset = 0; scheduleNextDeco();
    if (rafId) cancelAnimationFrame(rafId); rafId = null;
    loop();
  }

  /* —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–¥—Ä */
  resizeCanvas();
  document.getElementById('regOverlay').style.display = 'flex';
  (function first(){
    ctx.fillStyle='#000000'; ctx.fillRect(0,0,W,H);
    var g=ctx.createLinearGradient(0,GROUND_Y,W,GROUND_Y);
    g.addColorStop(0,'#53B5AF'); g.addColorStop(1,'#53B5AF');
    ctx.fillStyle=g; ctx.fillRect(0,GROUND_Y,W,2);
  })();
})();
</script>
</body>
</html>
