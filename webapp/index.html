<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>–ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± ‚Äî 8-bit Runner</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="46" fill="%2353B5AF"/><text x="50" y="70" text-anchor="middle" font-size="70" fill="black">üß™</text></svg>'>
  <style>
    :root{--brand:#53B5AF;--bg:#000000;--card:#000000;--text:#ffffff;--muted:#cfe9e7;--pad:12px;--app-height:100vh}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:monospace;background:var(--bg);color:var(--text)}
    #app-root{position:relative;width:100%;min-height:var(--app-height);display:flex}
    .wrap{flex:1;display:flex}
    .card{flex:1;display:flex;flex-direction:column;background:var(--card);border:3px solid var(--brand);image-rendering:pixelated;box-shadow:0 0 18px rgba(83,181,175,.35)}
    h1{font-size:20px;margin:0;padding:10px var(--pad);display:flex;align-items:center;gap:10px;background:linear-gradient(45deg, rgba(83,181,175,.10), rgba(83,181,175,.10));border-bottom:1px solid rgba(83,181,175,.35);color:var(--text)}
    .gameBox{flex:1;display:flex;flex-direction:column;min-height:0}
    canvas{display:block;width:100%;height:auto;background:#000000;image-rendering:pixelated;touch-action:manipulation;-webkit-user-select:none;user-select:none}
    .bar{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;padding:8px var(--pad);flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .btn{background:#000;color:var(--text);border:2px solid var(--brand);padding:8px 12px;cursor:pointer;border-radius:8px}
    .btn.brand{background:var(--brand);color:#000;border-color:transparent}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;padding:16px;z-index:999;height:var(--app-height)}
    .panel{background:#000;border:3px solid var(--brand);border-radius:10px;box-shadow:0 0 18px rgba(83,181,175,.35);width:100%;max-width:860px;max-height:calc(var(--app-height) - 32px);display:flex;flex-direction:column}
    .panel .inner{display:grid;gap:14px;padding:16px;grid-template-columns:1fr 320px;overflow:auto}
    @media (max-width:740px){.panel .inner{grid-template-columns:1fr}}
    #regOverlay .panel,#resultOverlay .panel{background:#fff;border:2px solid #e5e5e5;box-shadow:0 6px 28px rgba(0,0,0,.18)}
    #regOverlay input{width:100%;background:#fff;border:2px solid #e5e5e5;color:#000;padding:8px;border-radius:6px;margin-top:4px}
    #regOverlay .checkbox{color:#000}
    .qrbox{background:#fff;border:2px solid #e5e5e5;border-radius:10px;padding:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px}
    .qrbox img{max-width:260px;width:100%;height:auto;display:block}
    .qrbox small{color:#333;text-align:center;line-height:1.3}
  </style>
</head>
<body>
<div id="app-root">
  <div class="wrap">
    <div class="card">
      <h1>üß™ –ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± 8-bit Runner</h1>
      <div class="gameBox">
        <canvas id="game" width="1200" height="400"></canvas>
        <div class="bar">
          <div>–û—á–∫–∏: <span id="score">0</span> ¬∑ –†–µ–∫–æ—Ä–¥: <span id="best">0</span> ¬∑ –û—Å—Ç–∞–ª–æ—Å—å: <span id="timeLeft">02:00</span><div class="hint">Space / ‚¨ÜÔ∏é / –¢–∞–ø ¬∑ –î–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫ ‚Äî —Å–ª–∞–±–µ–µ</div></div>
          <div style="display:flex;gap:8px"><button id="restart" class="btn">–ó–∞–Ω–æ–≤–æ</button><button id="newSession" class="btn brand">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div>
        </div>
      </div>
    </div>
  </div>

  <!-- –§–æ—Ä–º–∞ -->
  <div id="regOverlay" class="overlay" style="display:flex">
    <div class="panel">
      <div class="inner">
        <div>
          <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
          <div><label>–§–∞–º–∏–ª–∏—è *</label><input id="lastName" type="text" required></div>
          <div><label>–ò–º—è *</label><input id="firstName" type="text" required></div>
          <div><label>–û—Ç—á–µ—Å—Ç–≤–æ</label><input id="middleName" type="text"></div>
          <div><label>–¢–µ–ª–µ—Ñ–æ–Ω *</label><input id="phone" type="tel" placeholder="+7 900 000-00-00"></div>
          <div><label>Email</label><input id="email" type="email" placeholder="name@example.com"></div>
          <label class="checkbox"><input id="consent" type="checkbox"> –°–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö</label>
          <div style="text-align:right;margin-top:12px"><button id="startBtn" class="btn brand">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button></div>
          <div id="regErr" style="color:#d50000;margin-top:6px"></div>
        </div>
        <div class="qrbox">
          <img src="assets/qr_group.jpg" alt="QR">
          <small>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR, —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –Ω–∞—à–µ–π –≥—Ä—É–ø–ø–µ –≤ Telegram –∏ –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à–∏ –∏ –Ω–æ–≤–æ—Å—Ç–∏.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
  <div id="resultOverlay" class="overlay">
    <div class="panel">
      <div class="inner" style="grid-template-columns:1fr">
        <div>
          <h2>–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
          <p>–í–∞—à –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <b id="finalBest">0</b> –æ—á–∫–æ–≤.</p>
          <p>–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: <b id="prizeText">‚Äî</b></p>
          <p>–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
  let W=canvas.width,H=canvas.height,GROUND_Y=H-32;
  const scoreEl=document.getElementById('score'),bestEl=document.getElementById('best'),timeEl=document.getElementById('timeLeft');
  let worldSpeed=6,score=0,best=0,gameOver=false,ready=false,runStart=0,sessionEndAt=null,timerId=null;
  let raf=null;
  const player={x:50,y:GROUND_Y-56,w:56,h:56,vy:0,onGround:true,jumpCount:0};
  const GRAVITY=0.85,JUMP_V1=-12,JUMP_V2=-9.5;
  const SPAWN_MIN=340,SPAWN_VAR=300;
  const obstacles=[];
  const OB_HIT_W=0.7,OB_HIT_H=0.65,PL_HIT_W=0.75,PL_HIT_H=0.85; // —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ —Ö–∏—Ç–±–æ–∫—Å—ã

  function aabb(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}
  function playerHB(p){return{x:p.x+(p.w*(1-PL_HIT_W)/2),y:p.y+(p.h*(1-PL_HIT_H)),w:p.w*PL_HIT_W,h:p.h*PL_HIT_H}}
  function obstacleHB(o){return{x:o.x+(o.w*(1-OB_HIT_W)/2),y:o.y+(o.h*(1-OB_HIT_H)),w:o.w*OB_HIT_W,h:o.h*OB_HIT_H}}

  function resize(){const r=canvas.parentElement.getBoundingClientRect();const w=r.width,h=r.height*0.75;canvas.style.width=w+'px';canvas.style.height=h+'px';canvas.width=w;canvas.height=h;W=w;H=h;GROUND_Y=H-32}
  window.addEventListener('resize',resize);resize();

  function spawnObs(){const h=40+Math.random()*40,w=30+Math.random()*60;obstacles.push({x:W+10,y:GROUND_Y-h,w,h,passed:false})}
  let st=0;
  function jump(){if(gameOver||!ready)return;if(player.onGround){player.vy=JUMP_V1;player.onGround=false;player.jumpCount=1;st=Date.now();return}
    if(player.jumpCount===1 && Date.now()-st<350){player.vy=JUMP_V2;player.jumpCount=2;}}
  window.addEventListener('keydown',e=>{if(['Space','ArrowUp'].includes(e.code)){e.preventDefault();jump();}});
  canvas.addEventListener('pointerdown',jump);

  function update(){
    ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#53B5AF';ctx.fillRect(0,GROUND_Y,W,2);
    if(Date.now()>sessionEndAt){showResults();return;}
    player.vy+=GRAVITY;player.y+=player.vy;
    if(player.y>=GROUND_Y-player.h){player.y=GROUND_Y-player.h;player.vy=0;player.onGround=true;player.jumpCount=0;}
    for(let i=obstacles.length-1;i>=0;i--){const o=obstacles[i];o.x-=worldSpeed;ctx.fillStyle='#53B5AF';ctx.fillRect(o.x,o.y,o.w,o.h);
      if(o.x+o.w<0)obstacles.splice(i,1);
      if(!o.passed && o.x+o.w<player.x){o.passed=true;score++;scoreEl.textContent=score;}
      if(!gameOver && aabb(playerHB(player),obstacleHB(o))){gameOver=true;if(score>best){best=score;bestEl.textContent=best;}}}
    ctx.fillStyle=gameOver?'#e33':'#fff';ctx.fillRect(player.x,player.y,player.w,player.h);
    if(!gameOver){raf=requestAnimationFrame(update);}
  }

  document.getElementById('restart').onclick=()=>{if(sessionActive())startGame();}
  document.getElementById('newSession').onclick=openReg;
  function sessionActive(){return sessionEndAt&&Date.now()<sessionEndAt;}
  function startGame(){score=0;gameOver=false;ready=true;runStart=Date.now();sessionEndAt=Date.now()+120000;obstacles.length=0;spawnObs();tick();update();}
  function tick(){clearInterval(timerId);timerId=setInterval(()=>{const left=sessionEndAt-Date.now();if(left<=0){clearInterval(timerId);showResults();}timeEl.textContent=fmt(left);},200);}
  const fmt=ms=>{const s=Math.ceil(ms/1000);return('0'+Math.floor(s/60)).slice(-2)+':'+('0'+s%60).slice(-2)}

  const reg=document.getElementById('regOverlay'),res=document.getElementById('resultOverlay');
  const btn=document.getElementById('startBtn'),err=document.getElementById('regErr');
  const f=document.getElementById('firstName'),l=document.getElementById('lastName'),m=document.getElementById('middleName'),ph=document.getElementById('phone'),em=document.getElementById('email'),cons=document.getElementById('consent');
  let profile={};

  function openReg(){err.textContent='';reg.style.display='flex';}
  function closeReg(){reg.style.display='none';}
  btn.onclick=()=>{if(!l.value.trim())return err.textContent='–§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞';
    if(!f.value.trim())return err.textContent='–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ';
    if(!cons.checked)return err.textContent='–ù—É–∂–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ';
    profile={lastName:l.value,firstName:f.value,middleName:m.value,phone:ph.value,email:em.value};
    closeReg();startGame();}
  
  function showResults(){
    document.getElementById('finalBest').textContent=best;
    document.getElementById('prizeText').textContent=getPrize(best);
    if(window.Telegram?.WebApp){
      const data={type:'lead',profile,best,ts:Date.now(),endedAt:new Date().toISOString()};
      window.Telegram.WebApp.sendData(JSON.stringify(data));
    }
    res.style.display='flex';
    setTimeout(()=>{res.style.display='none';openReg();},2500); // –∞–≤—Ç–æ–æ—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã
  }

  const getPrize=p=>p>=70?'–¢–µ—Ä–º–æ—Å':p>=50?'–®–æ–ø–ø–µ—Ä':p>=30?'–ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫–∞':p>=20?'–ë—Ä–µ–ª–æ–∫':'‚Äî';
  openReg();
})();
</script>
</body>
</html>
