<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>–ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± ‚Äî 8-bit Runner</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="46" fill="%2317F1E9"/><text x="50" y="70" text-anchor="middle" font-size="70" fill="black">üß™</text></svg>'>
  <style>
    :root{
      --brand:#17F1E9; --brand-2:#00C1C4;
      --bg:#000; --card:#0b0b0b; --text:#d9fff9; --muted:#9beee7;
      --pad:12px; --app-height:100vh;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family:monospace; background:var(--bg); color:var(--text); }

    /* –∫–æ—Ä–µ–Ω—å, –∫–æ—Ç–æ—Ä—ã–π ¬´–ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º¬ª –≤ –ø–æ—Ä—Ç—Ä–µ—Ç–µ */
    #app-root{ position:relative; width:100%; min-height:var(--app-height); display:flex; }
    .portrait-force-landscape #app-root{
      position:fixed; inset:0; transform:rotate(90deg); transform-origin:top left;
      width:calc(var(--app-height)); height:100vw; overflow:hidden; z-index:1;
    }

    .wrap{ flex:1; display:flex; }
    .card{ flex:1; display:flex; flex-direction:column; background:var(--card);
      border:3px solid var(--brand); image-rendering:pixelated; box-shadow:0 0 18px rgba(23,241,233,.45); }
    h1{ font-size:20px; margin:0; padding:10px var(--pad); display:flex; align-items:center; gap:10px;
        background:linear-gradient(45deg, rgba(23,241,233,.08), rgba(0,193,196,.08));
        border-bottom:1px solid rgba(23,241,233,.35); }
    .gameBox{ flex:1; display:flex; flex-direction:column; min-height:0; }
    canvas{ display:block; width:100%; height:auto; background:#111; image-rendering:pixelated; }
    .bar{ display:flex; justify-content:space-between; align-items:flex-start; gap:8px; padding:8px var(--pad); flex-wrap:wrap; }
    .hint{ font-size:12px; color:var(--muted); }
    .btn{ background:#101010; color:var(--text); border:2px solid var(--brand); padding:8px 12px; cursor:pointer; border-radius:8px; }
    .btn:active{ background:var(--brand); color:#001314; }
    .btn.brand{ background:linear-gradient(0.125turn, var(--brand) 0%, var(--brand-2) 100%); color:#001314; border-color:transparent; }

    /* –æ–≤–µ—Ä–ª–µ–∏ */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.9); display:none;
      align-items:center; justify-content:center; padding:16px; z-index:999; height:var(--app-height); }
    .panel{ background:#0e0e0e; border:3px solid var(--brand); border-radius:10px;
      box-shadow:0 0 18px rgba(23,241,233,.45); width:100%; max-width:860px;
      max-height:calc(var(--app-height) - 32px); display:flex; flex-direction:column; }
    .panel .inner{ display:grid; gap:14px; padding:16px; grid-template-columns:1fr 320px; overflow:auto; }
    @media (max-width:740px){ .panel .inner{ grid-template-columns:1fr; } }
    input[type="text"],input[type="tel"],input[type="email"]{
      width:100%; background:#000; border:2px solid var(--brand); color:#cffff8; padding:8px; border-radius:6px; margin-top:4px;
    }
    .field{ margin:6px 0; }
    .checkbox{ display:flex; gap:8px; align-items:flex-start; font-size:12px; color:#bffff6; }
    .note{ font-size:11px; color:#9beee7; }
    .prizes{ border:2px solid var(--brand); border-radius:8px; padding:10px; background:#0a0a0a; }
    .prizes h3{ margin:0 0 8px; font-size:16px; }
    .prize-row{ display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed rgba(23,241,233,.45); }
    .prize-row:last-child{ border-bottom:none; }

    .rotate-hint{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.8); color:#d9fff9; z-index:10000; text-align:center; padding:16px; border:3px solid #17F1E9; }
    .rotate-hint.show{ display:flex; }
  </style>
</head>
<body>
  <div id="app-root">
    <div class="wrap">
      <div class="card">
        <h1>üß™ –ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± 8-bit Runner</h1>
        <div class="gameBox">
          <canvas id="game" width="1200" height="400"></canvas>
          <div class="bar">
            <div>
              –û—á–∫–∏: <span id="score">0</span> ¬∑ –†–µ–∫–æ—Ä–¥: <span id="best">0</span> ¬∑ –û—Å—Ç–∞–ª–æ—Å—å: <span id="timeLeft">02:00</span>
              <div class="hint">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Space / ‚¨ÜÔ∏é / –¢–∞–ø ¬∑ –î–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫ ‚Äî –Ω–∞–∂–º–∏—Ç–µ –ø—Ä—ã–∂–æ–∫ –¥–≤–∞–∂–¥—ã.</div>
            </div>
            <div style="display:flex; gap:8px;">
              <button id="restart" class="btn">–ó–∞–Ω–æ–≤–æ</button>
              <button id="newSession" class="btn brand">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <div id="regOverlay" class="overlay" style="display:flex">
      <div class="panel">
        <div class="inner">
          <div>
            <h2 style="margin:4px 0 10px">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>

            <div class="field"><label>–§–∞–º–∏–ª–∏—è *</label>
              <input id="lastName" type="text" placeholder="–ò–≤–∞–Ω–æ–≤" required autocomplete="family-name"></div>
            <div class="field"><label>–ò–º—è *</label>
              <input id="firstName" type="text" placeholder="–ò–≤–∞–Ω" required autocomplete="given-name"></div>
            <div class="field"><label>–û—Ç—á–µ—Å—Ç–≤–æ <span class="note">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
              <input id="middleName" type="text" placeholder="–ò–≤–∞–Ω–æ–≤–∏—á" autocomplete="additional-name"></div>

            <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
              <input id="phone" type="tel" placeholder="+7 900 000-00-00" autocomplete="tel"></div>
            <div class="field"><label>Email</label>
              <input id="email" type="email" placeholder="name@example.com" autocomplete="email" inputmode="email"></div>

            <label class="checkbox"><input id="consent" type="checkbox"> –°–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</label>
            <div class="note">–î–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –≤—ã–¥–∞—á–∏ –ø—Ä–∏–∑–∞ –∏ —Å–≤—è–∑–∏ —Å –≤–∞–º–∏.</div>

            <div style="margin-top:12px; text-align:right;">
              <button id="startBtn" class="btn brand">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
            <div id="regErr" style="color:#ff8a8a; margin-top:6px;"></div>
          </div>

          <div class="prizes">
            <h3>–ü—Ä–∏–∑—ã –∏ –æ—á–∫–∏</h3>
            <div class="prize-row"><div>20‚Äì30</div><div>–ë—Ä–µ–ª–æ–∫</div></div>
            <div class="prize-row"><div>30‚Äì50</div><div>–ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫–∞</div></div>
            <div class="prize-row"><div>50‚Äì70</div><div>–®–æ–ø–ø–µ—Ä</div></div>
            <div class="prize-row"><div>70+</div><div>–¢–µ—Ä–º–æ—Å</div></div>
            <div class="note" style="margin-top:8px">–û—á–∫–∏ ‚Äî –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ 2 –º–∏–Ω—É—Ç—ã.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="resultOverlay" class="overlay">
      <div class="panel">
        <div class="inner" style="grid-template-columns:1fr;">
          <div>
            <h2 style="margin:4px 0 10px">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
            <p>–í–∞—à –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <b id="finalBest">0</b> –æ—á–∫–æ–≤.</p>
            <p>–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: <b id="prizeText">‚Äî</b></p>
            <p style="margin-top:8px">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∑–∞ –ø—Ä–∏–∑–æ–º.</p>
            <div style="margin-top:12px;text-align:right;">
              <button id="resultOk" class="btn brand">–ù–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="rotateHint" class="rotate-hint">–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–ø—ã—Ç–∞</div>

<script>
(function(){
  /* === Telegram fullscreen === */
  try{ if (window.Telegram?.WebApp){
    Telegram.WebApp.expand();
    Telegram.WebApp.setBackgroundColor("#000000");
    Telegram.WebApp.setHeaderColor("secondary_bg_color");
  }}catch(e){}

  /* === –†–µ–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ (—Ñ–∏–∫—Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã) === */
  function setAppHeight(){
    const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty('--app-height', vh + 'px');
  }
  setAppHeight();
  window.addEventListener('resize', setAppHeight);
  if (window.visualViewport){ window.visualViewport.addEventListener('resize', setAppHeight, {passive:true}); }

  /* === –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–ª—å–±–æ–º–Ω—ã–π —Ä–µ–∂–∏–º –≤ –ø–æ—Ä—Ç—Ä–µ—Ç–µ === */
  const root = document.documentElement;
  const rotateHint = document.getElementById('rotateHint');
  function applyOrientationMode(){
    const portrait = (window.innerHeight > window.innerWidth);
    if (portrait){ root.classList.add('portrait-force-landscape'); }
    else { root.classList.remove('portrait-force-landscape'); rotateHint.classList.remove('show'); }
    if (typeof resizeCanvas === 'function') setTimeout(resizeCanvas, 50);
  }
  window.addEventListener('orientationchange', applyOrientationMode);
  window.addEventListener('resize', applyOrientationMode);
  applyOrientationMode();

  /* === Canvas / —Ä–∞–∑–º–µ—Ä—ã –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ === */
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let W = canvas.width, H = canvas.height;
  let GROUND_Y = H - 32;
  function resizeCanvas(){
    const rect = canvas.parentElement.getBoundingClientRect();
    const cssW = Math.max(320, Math.floor(rect.width));
    const cssH = Math.max(220, Math.floor(rect.height * 0.75));
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.style.width = cssW+'px'; canvas.style.height = cssH+'px';
    canvas.width = Math.round(cssW*dpr); canvas.height = Math.round(cssH*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    W = cssW; H = cssH; GROUND_Y = H - 32;
  }
  window.addEventListener('resize', resizeCanvas);

  /* === –§–æ–Ω ‚Äî –±–µ—Å—à–æ–≤–Ω—ã–π —Ç–∞–π–ª === */
  const bgTile = new Image(); bgTile.src = "assets/background.png";
  let bgOffset = 0;
  function drawBackground(){
    if (!bgTile.complete){ ctx.fillStyle="#000"; ctx.fillRect(0,0,W,H); return; }
    const scale = H / bgTile.height;
    const tileW = Math.ceil(bgTile.width * scale);
    const speed = worldSpeed * 0.5;          // –ø–∞—Ä–∞–ª–ª–∞–∫—Å
    bgOffset = (bgOffset - speed);
    if (bgOffset <= -tileW) bgOffset += tileW;
    for (let x=-tileW; x < W + tileW; x += tileW){
      ctx.drawImage(bgTile, x + bgOffset, 0, tileW, H);
    }
  }

  /* === –î–µ–∫–æ—Ä —Å—Ç–µ–Ω—ã (3 –æ–±—ä–µ–∫—Ç–∞) === */
  function loadImg(src){ const im=new Image(); im.src=src; return im; }
  const DECOS = [
    { img: loadImg("assets/deco_clock.png"),   w:64, h:64, weight:2 },
    { img: loadImg("assets/deco_panel.png"),   w:80, h:80, weight:3 },
    { img: loadImg("assets/deco_console.png"), w:72, h:72, weight:1 }
  ];
  const bgDecos = []; const MAX_DECOS_ON_SCREEN = 6;
  let decoTimer = 0, decoIntervalMin=1800, decoIntervalVar=2200;
  function pickDecoByWeight(){
    const total = DECOS.reduce((s,d)=>s+d.weight,0);
    let r = Math.random()*total;
    for (const d of DECOS){ r -= d.weight; if (r<=0) return d; }
    return DECOS[0];
  }
  function randomWallY(){ const top=Math.round(H*0.20), bottom=Math.round(H*0.45); return Math.floor(top + Math.random()*(bottom-top)); }
  function scheduleNextDeco(){ decoTimer = performance.now() + decoIntervalMin + Math.random()*decoIntervalVar; }
  function updateDecoSpawner(now){
    if (bgDecos.length >= MAX_DECOS_ON_SCREEN) return;
    if (now >= decoTimer){
      const t = pickDecoByWeight(); const scale = 0.85 + Math.random()*0.4;
      bgDecos.push({ x: W+40, y: randomWallY(), w:Math.round(t.w*scale), h:Math.round(t.h*scale), img:t.img, speed:0.6+Math.random()*0.2 });
      scheduleNextDeco();
    }
  }
  function drawDecos(){
    for (let i=bgDecos.length-1; i>=0; i--){
      const d = bgDecos[i]; d.x -= worldSpeed * d.speed;
      if (d.img.complete){ ctx.imageSmoothingEnabled=false; ctx.drawImage(d.img, d.x, d.y, d.w, d.h); }
      if (d.x < -d.w-20) bgDecos.splice(i,1);
    }
  }

  /* === –ò–≥—Ä–æ–∫ (—Å–ø—Ä–∞–π—Ç—ã –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞) === */
  const playerSprites = {
    run: [ Object.assign(new Image(),{src:"assets/player_run1.png"}),
           Object.assign(new Image(),{src:"assets/player_run2.png"}) ],
    jump: Object.assign(new Image(),{src:"assets/player_jump.png"})
  };
  let playerAnimTime=0, playerAnimFrame=0;

  /* === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã === */
  const GRAVITY=0.65, JUMP_VELOCITY=-12.2;
  const SPEED_START=5, SPEED_ACCEL=0.02;         // –ø–ª–∞–≤–Ω—ã–π —Ä–æ—Å—Ç
  const SPAWN_MIN=180, SPAWN_VAR=180;
  let worldSpeed=SPEED_START, score=0, best=0, gameOver=false, ready=false, runStart=Date.now();

  const player = { x:50, y:GROUND_Y-56, w:56, h:56, vy:0, onGround:true, jumpCount:0, maxJumps:2 };

  function drawPlayer(){
    const inAir = !player.onGround;
    if (inAir){
      const img = playerSprites.jump;
      if (img.complete) ctx.drawImage(img, player.x, player.y, player.w, player.h);
      else { ctx.fillStyle="#0f0"; ctx.fillRect(player.x, player.y, player.w, player.h); }
    } else {
      playerAnimTime += worldSpeed;
      if (playerAnimTime > 18){ playerAnimTime=0; playerAnimFrame=(playerAnimFrame+1)%2; }
      const img = playerSprites.run[playerAnimFrame];
      if (img.complete) ctx.drawImage(img, player.x, player.y, player.w, player.h);
      else { ctx.fillStyle="#0f0"; ctx.fillRect(player.x, player.y, player.w, player.h); }
    }
  }

  /* === –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (4 –≤–∏–¥–∞) === */
  const SPRITES = {
    HIGH:   loadImg("assets/obstacle_high.png"),
    WIDE:   loadImg("assets/obstacle_wide.png"),
    MEDIUM: loadImg("assets/obstacle_medium.png"),
    FLY:    loadImg("assets/obstacle_fly.png")
  };
  const obstacles=[]; let spawnTimer=0;

  function spawnObstacle(){
    const type = Math.floor(Math.random()*4); // 0 —Å—Ä–µ–¥–Ω–µ–µ, 1 —à–∏—Ä–æ–∫–æ–µ, 2 –≤—ã—Å–æ–∫–æ–µ, 3 –ª–µ—Ç–∞—é—â–µ–µ
    let w,h,y,sprite;
    if (type===0){ w=64; h=64;  sprite=SPRITES.MEDIUM; y=GROUND_Y-h; }
    else if (type===1){ w=128; h=64; sprite=SPRITES.WIDE;   y=GROUND_Y-h; }
    else if (type===2){ w=64; h=128; sprite=SPRITES.HIGH;   y=GROUND_Y-h; }
    else { w=48; h=48; sprite=SPRITES.FLY; y=GROUND_Y-90-h; if (y<16) y=16; }
    obstacles.push({ x:W+10, y, w, h, sprite, passed:false });
  }

  function jump(){
    if (gameOver || !sessionActive() || !ready) return;
    if (player.jumpCount < player.maxJumps){ player.vy=JUMP_VELOCITY; player.onGround=false; player.jumpCount++; }
  }
  window.addEventListener('keydown', e=>{
    if (e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); jump(); }
    if (e.code==='Enter' && (gameOver || !sessionActive())) startCountdown(()=>resetRun());
  });
  canvas.addEventListener('pointerdown', jump);

  let rafId=null; function loop(){ cancelAnimationFrame(rafId); rafId=requestAnimationFrame(update); }

  function update(){
    /* —Ñ–æ–Ω –∏ –¥–µ–∫–æ—Ä */
    drawBackground();
    updateDecoSpawner(performance.now());
    drawDecos();

    /* –∑–µ–º–ª—è */
    const grd = ctx.createLinearGradient(0,GROUND_Y,W,GROUND_Y);
    grd.addColorStop(0,"#17F1E9"); grd.addColorStop(1,"#00C1C4");
    ctx.fillStyle = grd; ctx.fillRect(0,GROUND_Y,W,2);

    if (!sessionActive()){ dimOverlay('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'); return; }

    /* –ø–ª–∞–≤–Ω—ã–π —Ä–æ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ */
    const elapsedSec = (Date.now() - runStart)/1000;
    worldSpeed = SPEED_START + SPEED_ACCEL*elapsedSec;

    /* —Å–ø–∞–≤–Ω –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π */
    spawnTimer -= worldSpeed;
    if (spawnTimer <= 0){ spawnObstacle(); spawnTimer = SPAWN_MIN + Math.random()*SPAWN_VAR; }

    /* —Ñ–∏–∑–∏–∫–∞ –∏–≥—Ä–æ–∫–∞ */
    player.vy += GRAVITY; player.y += player.vy;
    if (player.y >= GROUND_Y - player.h){
      player.y = GROUND_Y - player.h; player.vy = 0;
      if (!player.onGround){ player.onGround = true; player.jumpCount = 0; }
    } else { player.onGround = false; }

    /* –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è */
    for (let i=obstacles.length-1;i>=0;i--){
      const o = obstacles[i]; o.x -= worldSpeed;

      if (o.sprite?.complete){ ctx.imageSmoothingEnabled=false; ctx.drawImage(o.sprite, o.x, o.y, o.w, o.h); }
      else { ctx.fillStyle='#17F1E9'; ctx.fillRect(o.x,o.y,o.w,o.h); }

      if (o.x + o.w < 0) obstacles.splice(i,1);
      if (!o.passed && o.x + o.w < player.x){ o.passed=true; score++; updateHud(); }
      if (!gameOver && collideForgiven(player,o,4)){ // —á—É—Ç—å –±–æ–ª—å—à–µ ¬´–ø—Ä–æ—â–µ–Ω–∏—è¬ª
        gameOver = true; if (score > best){ best = score; updateHud(); }
      }
    }

    /* –∏–≥—Ä–æ–∫ */
    drawPlayer();

    if (!ready){ drawCountdown(); return; }
    if (gameOver) return;

    loop();
  }

  function collideForgiven(a,b,f){
    const bx=b.x+f, by=b.y+f, bw=b.w-2*f, bh=b.h-2*f;
    return a.x < bx + bw && a.x + a.w > bx && a.y < by + bh && a.y + a.h > by;
  }

  /* === HUD / –∫–Ω–æ–ø–∫–∏ === */
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const timeEl  = document.getElementById('timeLeft');
  document.getElementById('restart').onclick = () => { if (!sessionActive()) return; startCountdown(()=>resetRun()); };
  document.getElementById('newSession').onclick = openReg;
  function updateHud(){ scoreEl.textContent = String(score); bestEl.textContent = String(best); }

  /* === –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / 2-–º–∏–Ω—É—Ç–Ω–∞—è —Å–µ—Å—Å–∏—è === */
  const regOverlay = document.getElementById('regOverlay');
  const resultOverlay = document.getElementById('resultOverlay');
  const startBtn = document.getElementById('startBtn');
  const resultOk = document.getElementById('resultOk');
  const regErr = document.getElementById('regErr');
  const lastNameIn = document.getElementById('lastName');
  const firstNameIn = document.getElementById('firstName');
  const middleNameIn = document.getElementById('middleName');
  const phoneIn = document.getElementById('phone');
  const emailIn = document.getElementById('email');
  const consentIn = document.getElementById('consent');
  const finalBest = document.getElementById('finalBest');
  const prizeText = document.getElementById('prizeText');

  let profile = null, sessionEndAt = null, timerId = null;

  function openReg(){ regErr.textContent=''; regOverlay.style.display='flex'; }
  function closeReg(){ regOverlay.style.display='none'; }

  function isEmailValid(v){ if (!v) return true; return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v.trim()); }

  startBtn.onclick = () => {
    const lastName = lastNameIn.value.trim();
    const firstName = firstNameIn.value.trim();
    const middleName = middleNameIn.value.trim();
    const phone = phoneIn.value.trim();
    const email = emailIn.value.trim();

    if (!lastName){ regErr.textContent = '–£–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é'; return; }
    if (!firstName){ regErr.textContent = '–£–∫–∞–∂–∏—Ç–µ –∏–º—è'; return; }
    if (!consentIn.checked) { regErr.textContent = '–ù—É–∂–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö'; return; }
    if (!isEmailValid(email)) { regErr.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e-mail'; return; }

    profile = { lastName, firstName, middleName, phone, email };
    best = 0; score = 0; updateHud();
    sessionEndAt = Date.now() + 2*60*1000; // 2 –º–∏–Ω—É—Ç—ã
    closeReg();
    startCountdown(()=>resetRun());
    tickTimer();
  };

  resultOk.onclick = () => { resultOverlay.style.display='none'; openReg(); };

  function tickTimer(){
    clearInterval(timerId);
    timerId = setInterval(()=>{
      const left = Math.max(0, (sessionEndAt || 0) - Date.now());
      timeEl.textContent = fmt(left);
      if (left <= 0){ clearInterval(timerId); showResults(); }
    }, 200);
  }
  function fmt(ms){ const s=Math.ceil(ms/1000), m=Math.floor(s/60), ss=String(s%60).padStart(2,'0'); return `${String(m).padStart(2,'0')}:${ss}`; }
  function sessionActive(){ return sessionEndAt && Date.now() < sessionEndAt; }

  function showResults(){
    finalBest.textContent = String(best);
    prizeText.textContent = getPrize(best);
    try{ if (window.Telegram?.WebApp){ Telegram.WebApp.sendData(JSON.stringify({ type:'session_result', profile, best })); } }catch(e){}
    resultOverlay.style.display='flex';
  }
  function getPrize(p){
    if (p >= 70) return '–¢–µ—Ä–º–æ—Å';
    if (p >= 50) return '–®–æ–ø–ø–µ—Ä';
    if (p >= 30) return '–ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫–∞';
    if (p >= 20) return '–ë—Ä–µ–ª–æ–∫';
    return '‚Äî';
  }

  /* === 3-2-1 –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º === */
  function startCountdown(cb){
    ready = false;
    let t = 3;
    const step = ()=>{
      drawCountdown(t);
      if (t === 0){ ready = true; cb && cb(); }
      else setTimeout(()=>{ t--; step(); }, 500);
    };
    step();
  }
  function drawCountdown(n){
    ctx.fillStyle = 'rgba(0,0,0,.35)'; ctx.fillRect(0,0,W,H);
    ctx.font = 'bold 56px monospace'; ctx.textAlign='center'; ctx.fillStyle = '#17F1E9';
    ctx.fillText(n ?? ' ', W/2, H/2);
  }
  function dimOverlay(msg){
    ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,W,H);
    ctx.font='16px monospace'; ctx.textAlign='center'; ctx.fillStyle='#d9fff9';
    ctx.fillText(msg, W/2, H/2);
  }

  /* === –°—Ç–∞—Ä—Ç === */
  resizeCanvas();
  document.getElementById('regOverlay').style.display = 'flex';
  (function first(){
    ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
    const g=ctx.createLinearGradient(0,GROUND_Y,W,GROUND_Y);
    g.addColorStop(0,'#17F1E9'); g.addColorStop(1,'#00C1C4');
    ctx.fillStyle=g; ctx.fillRect(0,GROUND_Y,W,2);
  })();
})();
</script>
</body>
</html>
