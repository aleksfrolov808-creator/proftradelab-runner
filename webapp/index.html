<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>–ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± ‚Äî 8-bit Runner</title>
<style>
:root{--brand:#53B5AF;--bg:#000;--text:#fff;--pad:12px;--app-height:100vh}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:monospace;background:var(--bg);color:var(--text)}
#app-root{position:relative;width:100%;min-height:var(--app-height);display:flex}
.wrap{flex:1;display:flex}
.card{flex:1;display:flex;flex-direction:column;background:#000;border:3px solid var(--brand)}
h1{margin:0;padding:10px var(--pad);font-size:20px}
.gameBox{flex:1;display:flex;min-height:0}
canvas{display:block;width:100%;height:100%;background:#000;image-rendering:pixelated;touch-action:manipulation}
.bar{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;padding:8px var(--pad);flex-wrap:wrap}
.btn{background:var(--brand);color:#000;border:none;padding:8px 12px;cursor:pointer;border-radius:8px}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:999;height:var(--app-height);padding:16px}
.panel{background:#fff;color:#000;border-radius:12px;width:100%;max-width:920px;box-shadow:0 10px 28px rgba(0,0,0,.25)}
.inner{display:grid;grid-template-columns:1fr 320px;gap:16px;padding:20px;max-height:calc(var(--app-height) - 48px);overflow:auto}
@media (max-width:760px){.inner{grid-template-columns:1fr}}
h2{margin:0 0 10px}
.field{margin:10px 0}
label{display:block;margin-bottom:6px}
input{width:100%;padding:10px;border:1px solid #e5e5e5;border-radius:8px;font-family:inherit}
.checkbox{display:flex;gap:8px;align-items:flex-start;font-size:12px}
.actions{margin-top:12px;text-align:right}
.prizes{background:#fafafa;border:1px solid #e5e5e5;border-radius:12px;padding:14px;height:max-content}
.prizes h3{margin:0 0 10px}
.prize-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px 0;border-bottom:1px dashed #e5e5e5}
.prize-row:last-child{border-bottom:none}
.badge{border:2px solid var(--brand);background:#eef8f7;border-radius:999px;padding:6px 10px;font-weight:700}
.error{color:#d60000;margin-top:6px}
</style>
</head>
<body>
<div id="app-root">
  <div class="wrap">
    <div class="card">
      <h1>üß™ –ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± 8-bit Runner</h1>
      <div class="gameBox">
        <canvas id="game" width="1200" height="400"></canvas>
      </div>
      <div class="bar">
        <div>–û—á–∫–∏: <span id="score">0</span> ¬∑ –†–µ–∫–æ—Ä–¥: <span id="best">0</span> ¬∑ –û—Å—Ç–∞–ª–æ—Å—å: <span id="timeLeft">02:00</span></div>
        <div style="display:flex;gap:8px"><button id="restart" class="btn">–ó–∞–Ω–æ–≤–æ</button><button id="newSession" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div>
      </div>
    </div>
  </div>

  <div id="regOverlay" class="overlay" style="display:flex">
    <div class="panel">
      <div class="inner">
        <div>
          <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
          <div class="field"><label>–§–∞–º–∏–ª–∏—è *</label><input id="lastName" type="text" autocomplete="family-name"></div>
          <div class="field"><label>–ò–º—è *</label><input id="firstName" type="text" autocomplete="given-name"></div>
          <div class="field"><label>–û—Ç—á–µ—Å—Ç–≤–æ <span style="font-size:12px;color:#666">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label><input id="middleName" type="text" autocomplete="additional-name"></div>
          <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω *</label><input id="phone" type="tel" placeholder="+7 900 000-00-00" autocomplete="tel"></div>
          <div class="field"><label>Email</label><input id="email" type="email" placeholder="name@example.com" autocomplete="email"></div>
          <label class="checkbox"><input id="consent" type="checkbox"> –°–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</label>
          <div id="regErr" class="error"></div>
          <div class="actions"><button id="startBtn" class="btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button></div>
        </div>
        <div class="prizes">
          <h3>–ü—Ä–∏–∑—ã –∏ –æ—á–∫–∏</h3>
          <div class="prize-row"><div><b>20‚Äì30</b></div><div class="badge">–ë—Ä–µ–ª–æ–∫</div></div>
          <div class="prize-row"><div><b>30‚Äì50</b></div><div class="badge">–ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫–∞</div></div>
          <div class="prize-row"><div><b>50‚Äì70</b></div><div class="badge">–®–æ–ø–ø–µ—Ä</div></div>
          <div class="prize-row"><div><b>70+</b></div><div class="badge">–¢–µ—Ä–º–æ—Å</div></div>
          <div style="font-size:12px;color:#444;margin-top:8px">–ó–∞—á—ë—Ç –∏–¥—ë—Ç –ø–æ –ª—É—á—à–µ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –∑–∞ 2 –º–∏–Ω—É—Ç—ã</div>
        </div>
      </div>
    </div>
  </div>

  <div id="resultOverlay" class="overlay">
    <div class="panel">
      <div class="inner" style="grid-template-columns:1fr">
        <div>
          <h2>–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
          <p>–í–∞—à –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <b id="finalBest">0</b> –æ—á–∫–æ–≤.</p>
          <p>–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: <b id="prizeText">‚Äî</b></p>
          <p>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∑–∞ –ø—Ä–∏–∑–æ–º.</p>
          <div class="actions"><button id="resultOk" class="btn">–ù–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
function setAppHeight(){const vh=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty('--app-height',vh+'px')}
setAppHeight();window.addEventListener('resize',setAppHeight);if(window.visualViewport){window.visualViewport.addEventListener('resize',setAppHeight,{passive:true})}

const cv=document.getElementById('game');const ctx=cv.getContext('2d')
let W=cv.width,H=cv.height,GROUND_Y=H-32
function resizeCanvas(){const holder=document.querySelector('.gameBox');const r=holder.getBoundingClientRect();const w=Math.max(320,Math.floor(r.width));const h=Math.max(220,Math.floor(r.height));const dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));cv.style.width=w+'px';cv.style.height=h+'px';cv.width=Math.round(w*dpr);cv.height=Math.round(h*dpr);ctx.setTransform(dpr,0,0,dpr,0,0);W=w;H=h;GROUND_Y=H-32}
window.addEventListener('resize',resizeCanvas);if(window.visualViewport){window.visualViewport.addEventListener('resize',resizeCanvas,{passive:true})}
resizeCanvas()

const GRAVITY=0.85,JUMP_VEL1=-12.2,JUMP_VEL2=-9.5,JUMP2_WINDOW=400,JUMP2_MIN_UP_VY=1
const TARGET_END_SPEED=11.8,SESSION_S=120,SPEED_START=5.76,SPEED_ACCEL=(TARGET_END_SPEED-SPEED_START)/SESSION_S
let worldSpeed=SPEED_START,score=0,best=0,gameOver=false,ready=false,runStart=Date.now(),countdown=0,countdownId=null

const player={x:50,y:GROUND_Y-56,w:56,h:56,vy:0,onGround:true,jumpCount:0,maxJumps:2,firstJumpAt:0}
const run1=new Image();run1.src='assets/run_1.png'
const run2=new Image();run2.src='assets/run_2.png'
const jumpImg=new Image();jumpImg.src='assets/jump.png'
let RUN_FRAME_MS=140,animMs=0,animFrame=0,lastTs=performance.now()

const SPR={HIGH:new Image(),WIDE:new Image(),MEDIUM:new Image(),FLY:new Image()}
SPR.HIGH.src='assets/obs_1.png';SPR.WIDE.src='assets/obs_2.png';SPR.MEDIUM.src='assets/obs_3.png';SPR.FLY.src='assets/fly_obs.png'
const bg=new Image();bg.src='assets/background.png'
let bgX=0

const scoreEl=document.getElementById('score'),bestEl=document.getElementById('best'),timeEl=document.getElementById('timeLeft')
document.getElementById('restart').onclick=()=>{if(!sessionActive())return;startWithCountdown()}
document.getElementById('newSession').onclick=()=>openReg()
function updateHud(){scoreEl.textContent=score;bestEl.textContent=best}

function drawBg(){if(!bg.complete){ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);return}const sc=H/bg.height;const tw=Math.ceil(bg.width*sc);bgX=(bgX-worldSpeed*0.5);if(bgX<=-tw)bgX+=tw;for(let x=-tw;x<W+tw;x+=tw)ctx.drawImage(bg,x+bgX,0,tw,H)}
function drawGround(){ctx.fillStyle='#53B5AF';ctx.fillRect(0,GROUND_Y,W,2)}
function drawPlayer(){if(!player.onGround){if(jumpImg.complete)ctx.drawImage(jumpImg,player.x,player.y,player.w,player.h);return}const now=performance.now();const dt=Math.min(100,now-lastTs);lastTs=now;animMs+=dt;if(animMs>=RUN_FRAME_MS){animMs-=RUN_FRAME_MS;animFrame=(animFrame+1)%2}const img=animFrame?run2:run1;if(img.complete)ctx.drawImage(img,player.x,player.y,player.w,player.h)}

function jump(){if(gameOver||!sessionActive()||!ready)return
if(player.onGround){player.vy=JUMP_VEL1;player.onGround=false;player.jumpCount=1;player.firstJumpAt=Date.now();return}
const since=Date.now()-player.firstJumpAt;if(player.jumpCount===1&&since<=JUMP2_WINDOW&&player.vy<JUMP2_MIN_UP_VY){player.vy=JUMP_VEL2;player.jumpCount=2}}
window.addEventListener('keydown',e=>{if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();jump()}if(e.code==='Enter'&&(gameOver||!sessionActive()))startWithCountdown()})
cv.addEventListener('pointerdown',jump)

let obstacles=[],spawnT=0,SPAWN_MIN=340,SPAWN_VAR=300,lastType=-1
function chooseType(){let pool=[0,1,2,3];if(lastType!==-1)pool=pool.filter(t=>t!==lastType);const t=pool[Math.floor(Math.random()*pool.length)];lastType=t;return t}
function spawnObs(){const t=chooseType();let w,h,y,s
if(t===0){w=56;h=56;s=SPR.MEDIUM;y=GROUND_Y-h}
else if(t===1){w=96;h=56;s=SPR.WIDE;y=GROUND_Y-h}
else if(t===2){w=52;h=104;s=SPR.HIGH;y=GROUND_Y-h}
else{w=64;h=40;s=SPR.FLY;y=GROUND_Y-90-h;if(y<16)y=16}
obstacles.push({x:W+10,y,w,h,sprite:s,passed:false,type:t})}

const OB_W=0.85,OB_H=0.80,PL_W=0.80,PL_H=0.90,HI_W=0.78,HI_H=0.70
function pBox(p){const w=p.w*PL_W,h=p.h*PL_H;return{x:p.x+(p.w-w)/2,y:p.y+(p.h-h),w,h}}
function oBox(o){let w,h;if(o.type===2){w=o.w*HI_W;h=o.h*HI_H}else{w=o.w*OB_W;h=o.h*OB_H}const x=o.x+(o.w-w)/2;const air=o.y<(GROUND_Y-o.h);const y=air?(o.y+(o.h-h)/2):(o.y+(o.h-h));return{x,y,w,h}}
function hit(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y}

let rafId=null
function loop(){cancelAnimationFrame(rafId);rafId=requestAnimationFrame(update)}
function update(){
  ctx.clearRect(0,0,W,H);drawBg();drawGround()
  if(!sessionActive()){return}
  const t=(Date.now()-runStart)/1000;worldSpeed=SPEED_START+SPEED_ACCEL*t
  if(!ready){ctx.fillStyle='rgba(0,0,0,.35)';ctx.fillRect(0,0,W,H);ctx.font='bold 72px monospace';ctx.textAlign='center';ctx.fillStyle='#53B5AF';ctx.fillText(countdown>0?countdown:'',W/2,H/2);loop();return}
  spawnT-=worldSpeed;if(spawnT<=0){spawnObs();const bonus=(Math.random()<0.18)?160:0;spawnT=SPAWN_MIN+Math.random()*SPAWN_VAR+bonus}
  player.vy+=GRAVITY;player.y+=player.vy
  if(player.y>=GROUND_Y-player.h){player.y=GROUND_Y-player.h;player.vy=0;if(!player.onGround){player.onGround=true;player.jumpCount=0}} else player.onGround=false
  for(let i=obstacles.length-1;i>=0;i--){const o=obstacles[i];o.x-=worldSpeed;if(o.sprite.complete)ctx.drawImage(o.sprite,o.x,o.y,o.w,o.h);if(o.x+o.w<0)obstacles.splice(i,1);if(!o.passed&&o.x+o.w<player.x){o.passed=true;score++;updateHud()}if(!gameOver&&hit(pBox(player),oBox(o))){gameOver=true;if(score>best)best=score;updateHud()}}
  drawPlayer()
  if(!gameOver)loop()
}

function resetRun(){runStart=Date.now();worldSpeed=SPEED_START;score=0;gameOver=false;player.y=GROUND_Y-player.h;player.vy=0;player.onGround=true;player.jumpCount=0;animMs=0;animFrame=0;lastTs=performance.now();obstacles.length=0;spawnT=0;bgX=0}

const reg=document.getElementById('regOverlay'),res=document.getElementById('resultOverlay'),startBtn=document.getElementById('startBtn'),resOk=document.getElementById('resultOk'),regErr=document.getElementById('regErr')
let profile=null,sessionEndAt=null,timerId=null
function openReg(){regErr.textContent='';reg.style.display='flex'}
function closeReg(){reg.style.display='none'}
function normalizePhone(v){if(!v)return'';let d=v.replace(/[^\d]/g,'');if(d.length<10||d.length>12)return'';if(d.length===11&&d[0]==='8')d='7'+d.slice(1);if(d.length===10)d='7'+d;return'+7'+d.slice(1)}
function isEmail(v){if(!v)return true;return/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v.trim())}
startBtn.onclick=()=>{const last=document.getElementById('lastName').value.trim();const first=document.getElementById('firstName').value.trim();const middle=document.getElementById('middleName').value.trim();const phoneRaw=document.getElementById('phone').value.trim();const email=document.getElementById('email').value.trim();const consent=document.getElementById('consent').checked;const phone=normalizePhone(phoneRaw);if(!last||!first){regErr.textContent='–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é';return}if(!phone){regErr.textContent='–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω';return}if(!consent){regErr.textContent='–ù—É–∂–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ';return}if(!isEmail(email)){regErr.textContent='–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e-mail';return}profile={lastName:last,firstName:first,middleName:middle,phone,email};best=0;score=0;updateHud();sessionEndAt=Date.now()+2*60*1000;closeReg();startWithCountdown()}
resOk.onclick=()=>{res.style.display='none';openReg()}
function tickTimer(){clearInterval(timerId);timerId=setInterval(()=>{const left=Math.max(0,(sessionEndAt||0)-Date.now());timeEl.textContent=timeFmt(left);if(left<=0){clearInterval(timerId);showResults()}},200)}
function timeFmt(ms){const s=Math.ceil(ms/1000),m=Math.floor(s/60),ss=('0'+(s%60)).slice(-2);return('0'+m).slice(-2)+':'+ss}
function sessionActive(){return sessionEndAt&&Date.now()<sessionEndAt}
function showResults(){document.getElementById('finalBest').textContent=best;document.getElementById('prizeText').textContent=prize(best);try{if(window.Telegram?.WebApp){window.Telegram.WebApp.sendData(JSON.stringify({type:'lead',profile,best,endedAt:new Date().toISOString()}))}}catch(e){}res.style.display='flex'}
function prize(p){if(p>=70)return'–¢–µ—Ä–º–æ—Å';if(p>=50)return'–®–æ–ø–ø–µ—Ä';if(p>=30)return'–ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫–∞';if(p>=20)return'–ë—Ä–µ–ª–æ–∫';return'‚Äî'}

function startWithCountdown(){ready=false;countdown=3;resetRun();loop();clearInterval(countdownId);countdownId=setInterval(()=>{countdown--;if(countdown<=0){clearInterval(countdownId);ready=true;tickTimer()}},700)}

document.getElementById('regOverlay').style.display='flex'
})();
</script>
</body>
</html>
